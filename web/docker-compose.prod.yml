# Docker Compose configuration for SudokuSolver web application (Production)
# This file uses pre-built images from GitHub Container Registry (GHCR)
# Use this for deploying to AWS Lightsail or other production environments
#
# CUSTOMIZATION REQUIRED:
# 1. Update image tags (lines 15, 50) to match your GHCR repository and version
# 2. Adjust port bindings (lines 23, 58) if ports 8001/8082 are in use
# 3. Update REDIS_URL (line 36) if using external Redis or different config
# 4. For subpath deployment, ensure frontend images were built with correct
#    VITE_BASE_PATH and VITE_API_BASE (see web/frontend/Dockerfile.prod)
#
# See web/README-deploy-images.md for detailed deployment instructions

services:
  # Redis service for session storage
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    # Note: Not exposing port 6379 to host - only accessible within Docker network

  # FastAPI backend service
  backend:
    # Pull pre-built image from GHCR
    # CUSTOMIZE: Update with your GHCR username and version tag
    # Format: ghcr.io/YOUR_USERNAME/sudoku-backend:VERSION
    image: ghcr.io/wmurphy41/sudoku-backend:v2026.02.07
    
    # Container name for easy reference
    container_name: sudoku-backend
    
    # Bind to localhost:8001 on host (accessible only from server nginx)
    # Server nginx proxies /sudokusolver/api/* to this port
    # CUSTOMIZE: Change port 8001 if it conflicts with other services
    ports:
      - "127.0.0.1:8001:8000"
    
    # Depends on Redis service
    depends_on:
      - redis
    
    # Restart policy: restart unless manually stopped
    restart: unless-stopped
    
    # Environment variables
    # CUSTOMIZE: REDIS_URL can be overridden via .env file or environment
    # For external Redis: redis://host:port/db
    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
    
    # Health check to ensure service is running
    # Note: Healthcheck uses container-internal port 8000, not host port 8001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx + React frontend service
  web:
    # Pull pre-built image from GHCR
    # CUSTOMIZE: Update with your GHCR username and version tag
    # Format: ghcr.io/YOUR_USERNAME/sudoku-web:VERSION
    # IMPORTANT: Image must be built with correct VITE_BASE_PATH and VITE_API_BASE
    image: ghcr.io/wmurphy41/sudoku-web:v2026.02.07
    
    # Container name for easy reference
    container_name: sudoku-web
    
    # Bind to localhost:8082 on host (accessible only from server nginx)
    # Server nginx proxies /sudokusolver/ to this port
    # CUSTOMIZE: Change port 8082 if it conflicts with other services
    # CUSTOMIZE: Update server nginx config to match this port
    ports:
      - "127.0.0.1:8082:80"
    
    # This service depends on the backend service
    # Docker will start backend first, then web
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_started
    
    # Restart policy: restart unless manually stopped
    restart: unless-stopped
    
    # Health check to ensure nginx is serving content
    # Note: Healthcheck uses container-internal URL, not host port
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Note: To use specific version tags instead of 'latest':
# 1. Build and push with version: .\scripts\build-push.ps1 v0.1.0
# 2. Update image tags above to: ghcr.io/wmurphy41/sudoku-backend:v0.1.0
# 3. This allows for version pinning and easy rollbacks





