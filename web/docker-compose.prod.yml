# Docker Compose configuration for SudokuSolver web application (Production)
# This file uses pre-built images from GitHub Container Registry (GHCR)
# Use this for deploying to AWS Lightsail or other production environments

services:
  # Redis service for session storage
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    # Note: Not exposing port 6379 to host - only accessible within Docker network

  # FastAPI backend service
  backend:
    # Pull pre-built image from GHCR
    image: ghcr.io/wmurphy41/sudoku-backend:v2025.11.26
    
    # Container name for easy reference
    container_name: sudoku-backend
    
    # Bind to localhost:8001 on host (accessible only from server nginx)
    # Server nginx proxies /sudokusolver/api/* to this port
    ports:
      - "127.0.0.1:8001:8000"
    
    # Depends on Redis service
    depends_on:
      - redis
    
    # Restart policy: restart unless manually stopped
    restart: unless-stopped
    
    # Environment variables
    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
    
    # Health check to ensure service is running
    # Note: Healthcheck uses container-internal port 8000, not host port 8001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx + React frontend service
  web:
    # Pull pre-built image from GHCR
    image: ghcr.io/wmurphy41/sudoku-web:v2025.11.26
    
    # Container name for easy reference
    container_name: sudoku-web
    
    # Bind to localhost:8082 on host (accessible only from server nginx)
    # Server nginx proxies /sudokusolver/ to this port
    ports:
      - "127.0.0.1:8082:80"
    
    # This service depends on the backend service
    # Docker will start backend first, then web
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_started
    
    # Restart policy: restart unless manually stopped
    restart: unless-stopped
    
    # Health check to ensure nginx is serving content
    # Note: Healthcheck uses container-internal URL, not host port
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Note: To use specific version tags instead of 'latest':
# 1. Build and push with version: .\scripts\build-push.ps1 v0.1.0
# 2. Update image tags above to: ghcr.io/wmurphy41/sudoku-backend:v0.1.0
# 3. This allows for version pinning and easy rollbacks





