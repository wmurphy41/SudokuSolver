# Docker Compose configuration for SudokuSolver web application (Production)
# This file uses pre-built images from GitHub Container Registry (GHCR)
# Use this for deploying to AWS Lightsail or other production environments

services:
  # FastAPI backend service
  backend:
    # Pull pre-built image from GHCR
    image: ghcr.io/wmurphy41/sudoku-backend:latest
    
    # Container name for easy reference
    container_name: sudoku-backend
    
    # Expose port 8000 internally (not accessible from host)
    # The nginx service will proxy requests to this port
    expose:
      - "8000"
    
    # Restart policy: restart unless manually stopped
    restart: unless-stopped
    
    # Environment variables
    environment:
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
    
    # Health check to ensure service is running
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx + React frontend service
  web:
    # Pull pre-built image from GHCR
    image: ghcr.io/wmurphy41/sudoku-web:latest
    
    # Container name for easy reference
    container_name: sudoku-web
    
    # Map host port 80 to container port 80
    # This makes the application accessible at http://YOUR_SERVER_IP
    ports:
      - "80:80"
    
    # This service depends on the backend service
    # Docker will start backend first, then web
    depends_on:
      backend:
        condition: service_healthy
    
    # Restart policy: restart unless manually stopped
    restart: unless-stopped
    
    # Health check to ensure nginx is serving content
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Note: To use specific version tags instead of 'latest':
# 1. Build and push with version: .\scripts\build-push.ps1 v0.1.0
# 2. Update image tags above to: ghcr.io/wmurphy41/sudoku-backend:v0.1.0
# 3. This allows for version pinning and easy rollbacks

