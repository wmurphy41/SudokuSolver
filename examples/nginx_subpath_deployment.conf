# ============================================================================
# Nginx Configuration for SudokuSolver Subpath Deployment
# ============================================================================
# This configuration demonstrates how to deploy SudokuSolver under a subpath
# (e.g., /sudokusolver) on the same server hosting other applications
# (e.g., AI_Flashcards at /flashcards).
#
# CUSTOMIZATION REQUIRED:
# 1. Update server_name (line 23) to match your domain
# 2. Update proxy_pass ports (lines 34, 48, 78, 92) to match your container ports
# 3. Update location paths (/sudokusolver/) if using a different subpath
# 4. Adjust timeout values if needed for your use case
#
# Deployment Scenario:
# - Domain: wmurphy41.com
# - AI_Flashcards: http://wmurphy41.com/flashcards/
# - SudokuSolver: http://wmurphy41.com/sudokusolver/
#
# Container Setup:
# - AI_Flashcards frontend: localhost:8081
# - AI_Flashcards backend: localhost:8000
# - SudokuSolver frontend: localhost:8082
# - SudokuSolver backend: localhost:8001
#
# ============================================================================

server {
    listen 80;
    # CUSTOMIZE: Update to match your domain name
    server_name wmurphy41.com;

    # ========================================================================
    # AI_Flashcards Configuration
    # ========================================================================
    # Backend API under /flashcards/api/*
    # Rewrites /flashcards/api/* to /api/* and proxies to backend container
    location ^~ /flashcards/api/ {
        # Rewrite /flashcards/api/... -> /api/... for FastAPI
        rewrite ^/flashcards/api(/.*)$ /api$1 break;

        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend SPA under /flashcards/*
    # Proxies to frontend container (which handles SPA routing internally)
    location ^~ /flashcards/ {
        # Strip /flashcards/ prefix when proxying to the frontend container
        # The trailing slash in proxy_pass removes the /flashcards/ prefix
        proxy_pass http://127.0.0.1:8081/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Optional: normalize /flashcards -> /flashcards/
    location = /flashcards {
        return 301 /flashcards/;
    }

    # ========================================================================
    # SudokuSolver Configuration
    # ========================================================================
    # IMPORTANT: Location block order matters!
    # More specific paths (/sudokusolver/api/) must come before less specific
    # paths (/sudokusolver/) to ensure correct routing.
    
    # Backend API under /sudokusolver/api/*
    # Rewrites /sudokusolver/api/* to /api/* and proxies to backend container
    # CUSTOMIZE: Change /sudokusolver/api/ to match your desired subpath
    location ^~ /sudokusolver/api/ {
        # Rewrite /sudokusolver/api/... -> /api/... for FastAPI
        # The backend FastAPI app expects routes at /api/*, so we strip
        # the /sudokusolver prefix before proxying
        # CUSTOMIZE: Update rewrite pattern if using different subpath
        rewrite ^/sudokusolver/api(/.*)$ /api$1 break;

        # Proxy to SudokuSolver backend container (bound to localhost:8001)
        # CUSTOMIZE: Update port 8001 to match your docker-compose.prod.yml backend port
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings for API requests
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Frontend SPA under /sudokusolver/*
    # Proxies to frontend container (which handles SPA routing internally)
    # CUSTOMIZE: Change /sudokusolver/ to match your desired subpath
    location ^~ /sudokusolver/ {
        # Strip /sudokusolver/ prefix when proxying to the frontend container
        # The trailing slash in proxy_pass removes the /sudokusolver/ prefix
        # The container nginx serves the app as if mounted at root (/)
        # and handles SPA fallback via try_files $uri /index.html;
        # CUSTOMIZE: Update port 8082 to match your docker-compose.prod.yml frontend port
        proxy_pass http://127.0.0.1:8082/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Optional: normalize /sudokusolver -> /sudokusolver/
    location = /sudokusolver {
        return 301 /sudokusolver/;
    }

    # ========================================================================
    # Optional: Security Hardening
    # ========================================================================
    # Explicitly block root /api/* from public access (prevents direct
    # backend access without subpath). Uncomment if desired:
    #
    # location /api/ {
    #     return 404;
    # }
}

# ============================================================================
# Deployment Instructions
# ============================================================================
#
# 1. Copy this configuration to your nginx sites-available directory:
#    sudo cp examples/nginx_subpath_deployment.conf /etc/nginx/sites-available/wmurphy41.com
#
# 2. Enable the site:
#    sudo ln -s /etc/nginx/sites-available/wmurphy41.com /etc/nginx/sites-enabled/
#
# 3. Test the configuration:
#    sudo nginx -t
#
# 4. Reload nginx:
#    sudo systemctl reload nginx
#
# ============================================================================
# Docker Compose Configuration Requirements
# ============================================================================
#
# For this nginx configuration to work, your docker-compose.prod.yml must
# bind containers to localhost only:
#
# services:
#   backend:
#     ports:
#       - "127.0.0.1:8001:8000"  # Backend on localhost:8001
#
#   web:
#     ports:
#       - "127.0.0.1:8082:80"    # Frontend on localhost:8082
#
# This ensures containers are only accessible from the server nginx,
# not directly from the internet.
#
# ============================================================================
# Frontend Build Requirements
# ============================================================================
#
# The SudokuSolver frontend must be built with the correct base path:
#
# Build arguments:
#   VITE_BASE_PATH=/sudokusolver/
#   VITE_API_BASE=/sudokusolver/api
#
# These are set in the Dockerfile.prod build stage and ensure:
# - Asset paths include /sudokusolver/ prefix
# - API calls use /sudokusolver/api/* paths
#
# ============================================================================
# Testing the Configuration
# ============================================================================
#
# After deployment, test with:
#
# # Test frontend
# curl -I http://wmurphy41.com/sudokusolver/
# # Expected: HTTP/1.1 200 OK
#
# # Test API
# curl http://wmurphy41.com/sudokusolver/api/healthz
# # Expected: {"status":"ok"}
#
# # Test asset paths
# curl http://wmurphy41.com/sudokusolver/ | grep -o '/sudokusolver/assets/[^"]*'
# # Should show asset URLs with /sudokusolver/ prefix
#
# ============================================================================
# Troubleshooting
# ============================================================================
#
# 1. 404 errors:
#    - Check that containers are running: docker ps
#    - Verify ports match: 8082 (frontend), 8001 (backend)
#    - Test direct access: curl http://localhost:8082/
#
# 2. API not working:
#    - Check backend logs: docker logs sudoku-backend
#    - Test backend directly: curl http://localhost:8001/api/healthz
#    - Verify rewrite rule is correct
#
# 3. Assets 404:
#    - Verify frontend was built with VITE_BASE_PATH=/sudokusolver/
#    - Check browser DevTools Network tab for actual asset URLs
#    - Ensure frontend container nginx serves assets correctly
#
# 4. Location block conflicts:
#    - Ensure more specific paths come first (/sudokusolver/api/ before /sudokusolver/)
#    - Use ^~ prefix to prevent regex matching conflicts
#    - Check nginx error logs: sudo tail -f /var/log/nginx/error.log
#
# ============================================================================
